WITH
-- MÃ©tricas do GA4
ga4 AS (
  SELECT
    COUNT(DISTINCT user_pseudo_id) AS total_users,
    COUNTIF(event_name = 'Signup CI') AS total_signups,
    COUNTIF(event_name = 'Demo button click') AS total_demos,
    COUNT(DISTINCT
      CASE
        WHEN page.location LIKE '%blog%' OR page.location LIKE '%resources%'
        THEN user_pseudo_id
      END
    ) AS users_on_blog_resources,
    COUNT(DISTINCT
      CASE
        WHEN event_name = 'session_start'
          AND first_user_traffic_source.source IN (
            'chatgpt.com', 'claude.ai', 'perplexity.ai',
            'gemini.google.com', 'copilot.microsoft.com'
          )
        THEN user_pseudo_id
      END
    ) AS users_from_llm_source
  FROM
    `demodesk-business-intelligence.superform_outputs_312378099.ga4_events`
),

-- Custos do Ads
ads AS (
  SELECT
    SUM(metrics_cost_micros) / 1000000 AS total_cost
  FROM
    `demodesk-business-intelligence.superform_outputs_312378099.p_ads_AccountStats_9934198558`
)

-- Combina os dois resultados (sem chave)
SELECT
  ga4.total_users,
  ga4.total_signups,
  ga4.total_demos,
  ga4.users_on_blog_resources,
  ga4.users_from_llm_source,

  -- Conversion rate
  ROUND(
    CASE
      WHEN ga4.total_users = 0 THEN 0
      ELSE ((ga4.total_signups + ga4.total_demos) / ga4.total_users) * 100
    END, 2
  ) AS conversion_rate,

  -- CAC
  ROUND(
    CASE
      WHEN (ga4.total_signups + ga4.total_demos) = 0 THEN 0
      ELSE ads.total_cost / (ga4.total_signups + ga4.total_demos)
    END, 2
  ) AS CAC

FROM ga4, ads   -- <<=== sem chave, apenas combina os dois conjuntos agregados
LIMIT 100;
